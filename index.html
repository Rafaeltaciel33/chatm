<!DOCTYPE html>
<html>
<head>
  <title>Chat Firebase</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>

  <div>
    <div id="usersOnline">Usuários online: 0</div>
  </div>

  <div id="messages"></div>

  <input type="text" id="msgInput" placeholder="Digite sua mensagem" />
  <button id="sendBtn">Enviar</button>

  <script>
    // Config Firebase - seu config correto aqui!
    const firebaseConfig = {
      apiKey: "AIzaSyCL8S1BlDqcfBeRk6dJtd-ukDC0uwtHogo",
      authDomain: "chat-9e78e.firebaseapp.com",
      databaseURL: "https://chat-9e78e-default-rtdb.firebaseio.com",
      projectId: "chat-9e78e",
      storageBucket: "chat-9e78e.appspot.com",
      messagingSenderId: "1087471527921",
      appId: "1:1087471527921:web:9fe8d3e2a4bf78bc5d4650",
      measurementId: "G-V54VKM906H"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Pede nome do usuário e guarda id no localStorage
    let username = localStorage.getItem('username');
    if (!username) {
      username = prompt('Qual seu nome?');
      if (!username) username = 'Anon';
      localStorage.setItem('username', username);
    }

    // Gera um userId único e salva no localStorage para controlar presença
    let userId = localStorage.getItem('userId');
    if (!userId) {
      userId = Date.now().toString() + Math.floor(Math.random() * 1000);
      localStorage.setItem('userId', userId);
    }

    // Marca usuário como online no DB
    const userRef = db.ref('users/' + userId);
    userRef.set({ username: username, online: true });
    userRef.onDisconnect().remove();

    // Escuta usuários online e atualiza contador
    db.ref('users').on('value', snapshot => {
      const users = snapshot.val() || {};
      const onlineUsers = Object.values(users).filter(u => u.online).length;
      document.getElementById('usersOnline').innerText = 'Usuários online: ' + onlineUsers;
    });

    // Função para mostrar mensagens na tela
    function showMessages(messages) {
      const div = document.getElementById('messages');
      div.innerHTML = '';
      for (const key in messages) {
        const msg = messages[key];
        const p = document.createElement('p');
        p.textContent = `${msg.username}: ${msg.text}`;
        div.appendChild(p);
      }
      div.scrollTop = div.scrollHeight;
    }

    // Escuta mensagens no DB
    db.ref('messages').on('value', snapshot => {
      const messages = snapshot.val() || {};
      showMessages(messages);
    });

    // Envia mensagem ao clicar no botão
    document.getElementById('sendBtn').onclick = () => {
      const input = document.getElementById('msgInput');
      const text = input.value.trim();
      if (!text) return;
      const newMsgRef = db.ref('messages').push();
      newMsgRef.set({
        username: username,
        text: text,
        timestamp: Date.now()
      });
      input.value = '';
    };

  </script>

</body>
</html>
